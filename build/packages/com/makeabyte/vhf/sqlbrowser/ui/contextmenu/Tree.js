if(!window.qxsettings)qxsettings={};if(qxsettings["qx.version"]==undefined)qxsettings["qx.version"]="0.0";if(qxsettings["qx.isSource"]==undefined)qxsettings["qx.isSource"]=false;if(!window.qxvariants)qxvariants={};qx.Class.define("packages.com.makeabyte.vhf.sqlbrowser.ui.contextmenu.Tree",{extend:vhf.Main,properties:{WireFrame:{init:vhf.Main.getInstance()},Menu:{init:new qx.ui.menu.Menu},Tree:{},RowData:{init:[]},Callback:{},UserDatabases:{}},construct:function(obj){this.setTree(obj[0]);this.setCallback(obj[1]);this.setUserDatabases(obj[2]);this.getMenu().addToDocument();this.getTree().setContextMenu(this.getMenu());this.getTree().addEventListener("contextmenu",function(e){this.getMenu().removeAll();this.showContextMenu(e);},this);},members:{__drop:function(selectedDB){this.getWireFrame()._setStatusText("Dropping database "+selectedDB+"...");var node=this.getTree().getHierarchy(this.getTree().getDataModel().getSelectedNodes()[0].nodeId).reverse()[0];var values=/<div style='display:none'>(.*)<\/div>(.*)/(node);var dbtype=values[1];var dbname=values[2];for(var i=0;i<this.getUserDatabases().count;i++){if(this.getUserDatabases()[i].databasetype[0]==dbtype&&this.getUserDatabases()[i].databasename[0]==dbname){var dn="databaseName="+dbname+this.getWireFrame().getUserAttribs().dn.replace("cn="+this.getWireFrame().getUserAttribs().uid[0],"");var json='['+'{ "name" : "dn", "dn" : "'+dn+'" },'+'{ "name" : "databaseType", "databaseType" : "'+dbtype+'" },'+'{ "name" : "databaseHost", "databaseHost" : "'+this.getUserDatabases()[i].databasehost[0]+'" },'+'{ "name" : "databaseName", "databaseName" : "'+dbname+'" }'+']';alert(json);var callback=qx.lang.Function.bind(this.__dropHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","SQLBROWSER","drop",json);}}},__dropHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Error");this.getWireFrame()._setStatusText("RPC Error!");}if(result){this.getCallback()();this.getWireFrame()._setStatusText("Ready");}},showContextMenu:function(ev){var drop=new qx.client.Command;drop.addEventListener("execute",function(e){var tree=e.getData().getParentMenu().getOpener();var selectedDB=tree.getHierarchy(tree.getDataModel().getSelectedNodes()[0].nodeId).reverse()[0];var confirmCallback=qx.lang.Function.bind(this.__drop,this);this.getWireFrame()._showConfirmDialog("Are you sure you want to drop the database "+selectedDB+"?","Delete Database",confirmCallback,selectedDB);},this);var createConnection=new qx.ui.menu.Button("Create Connection","icon/16/actions/edit-delete.png");createConnection.setEnabled(false);var copyTo=new qx.ui.menu.Button("Copy To","icon/16/actions/edit-delete.png");copyTo.setEnabled(false);this.getMenu().add(createConnection);this.getMenu().add(new qx.ui.menu.Button("Drop","icon/16/actions/edit-delete.png",drop));this.getMenu().add(new qx.ui.menu.Separator());this.getMenu().add(copyTo);this.getTree().getContextMenu().setLeft(ev.getClientX());this.getTree().getContextMenu().setTop(ev.getClientY());this.getTree().getContextMenu().setOpener(this.getTree());this.getTree().getContextMenu().show();},terminate:function(){this.base(arguments);}}});
