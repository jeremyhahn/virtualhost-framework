if(!window.qxsettings)qxsettings={};if(qxsettings["qx.version"]==undefined)qxsettings["qx.version"]="0.0";if(qxsettings["qx.isSource"]==undefined)qxsettings["qx.isSource"]=false;if(!window.qxvariants)qxvariants={};qx.Class.define("packages.com.makeabyte.vhf.ldapbrowser.ui.Browser",{extend:vhf.Main,properties:{WireFrame:{init:vhf.Main.getInstance()},BrowserWin:{init:new qx.ui.window.Window("LDAP Browser","icon/16/apps/system-users.png")},TreeSource:{init:new qx.ui.treevirtual.TreeVirtual(["LDAP Server"])},TreeModal:{},TableModel:{init:new qx.ui.table.model.Simple()},Table:{},TableRowData:{init:[]},SelectedRdn:{},BaseDn:{}},construct:function(){var modBtn=new qx.ui.menu.Button("LDAP Browser","icon/16/apps/system-users.png");modBtn.addEventListener("execute",function(e){this.main();},this);this._setModuleButton(modBtn);this.getBrowserWin().set({showMinimize:true,allowMinimize:false,allowMaximize:true});this.getBrowserWin().setSpace(0,'100%',0,'100%');var tblLayout=new qx.ui.layout.VerticalBoxLayout();tblLayout.set({left:0,top:0,right:1,bottom:0,spacing:3});this.getTreeSource().set({width:"100%",height:this.getWireFrame().getWorkspace().getInnerHeight()-20,border:"inset-thin",backgroundColor:"white",overflow:"hidden"});this.getTreeSource().setAlwaysShowOpenCloseSymbol(false);this.setTreeModal(this.getTreeSource().getDataModel());this.getTreeSource().addEventListener("changeSelection",function(e){var nodes=e.getData();if(!nodes[0])return;var rdn=this.getTreeSource().getHierarchy(nodes[0].nodeId).reverse().join(",");rdn=rdn.replace(/<div style='display:none'>/ig,"");rdn=rdn.replace(/<\/div>/ig,"=");this.setSelectedRdn(rdn);this.getEntries(this.getSelectedRdn());},this);this.getTableModel().setColumns(["Name","Description","Type"]);var custom={tableColumnModel:function(obj){return new qx.ui.table.columnmodel.Resize(obj);}};this.setTable(new qx.ui.table.Table(this.getTableModel(),custom));with(this.getTable()){set({width:'99%',height:'100%',border:"inset-thin"});setMetaColumnCounts([1,-1]);getSelectionModel().setSelectionMode(qx.ui.table.selection.Model.SINGLE_SELECTION);}tblLayout.add(this.getTable());var tcm=this.getTable().getTableColumnModel();var resizeBehavior=tcm.getBehavior();resizeBehavior.setWidth(0,200);resizeBehavior.setMinWidth(0,50);resizeBehavior.setMaxWidth(0,300);resizeBehavior.setWidth(1,300);resizeBehavior.setMinWidth(1,50);resizeBehavior.setMaxWidth(1,300);resizeBehavior.setWidth(2,100);resizeBehavior.setMinWidth(2,25);resizeBehavior.setMaxWidth(2,150);var mainSplitPane=new qx.ui.splitpane.HorizontalSplitPane(300,"1*");mainSplitPane.set({height:"100%",width:"100%",border:"line-left"});mainSplitPane.setLiveResize(true);mainSplitPane.addLeft(this.getTreeSource());mainSplitPane.addRight(tblLayout);this.getBrowserWin().add(mainSplitPane);},members:{main:function(){if(this.getTreeSource().hasChildren())this.getTreeSource().getDataModel().prune(0,true);var callback=qx.lang.Function.bind(this.__populateTreeHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","LDAP","getTreeSource",null);this.getWireFrame()._addToWorkspace(this.getBrowserWin());this.getBrowserWin().open();this.getBrowserWin().maximize();},__populateTreeHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Error",null);this.getWireFrame()._setStatusText("RPC Error!");}if(result){this.setBaseDn(result.base);this.buildTree(result.treeSource);var TreeCallback=qx.lang.Function.bind(this.main,this);var TableCallback=qx.lang.Function.bind(this.getEntries,this);this.loadContextMenu("Tree",Array(this.getTreeSource(),TreeCallback,TableCallback,this.getBaseDn()));var callback=qx.lang.Function.bind(this.getEntries,this);this.loadContextMenu("Object",Array(this.getTable(),callback,this.getBaseDn()));}},buildTree:function(treeArray){var pieces=this.getBaseDn().split("=");var rootNode=this.getTreeModal().addBranch(null,"<div style='display:none'>"+pieces[0]+"</div>"+pieces[1],true);this.getTreeSource().setNodeType(rootNode,"DN");this.getTreeModal().setData();this.addChildNodes(rootNode,treeArray);},addChildNodes:function(parentNode,branchArray){for(var i=0;i<branchArray.length;i++){if(!this.getWireFrame().isArray(branchArray[i])){var pieces=branchArray[i].dn.split(",")[0].split("=");var specialTypes=["dcobject","dcObject"];var ico;var bFound=false;for(var j=0;j<branchArray[i].objectclass.count;j++){if((branchArray[i].objectclass!==undefined)&&(branchArray[i].objectclass[j]=="dNSDomain")){bFound=true;var node=this.getTreeModal().addBranch(parentNode,"<div style='display:none'>"+pieces[0]+"</div>"+pieces[1],true,null,"icon/16/places/network-server.png","icon/16/places/network-server.png");this.getTreeSource().setNodeType(node,"OU");break;}}if(!bFound){var node=this.getTreeModal().addBranch(parentNode,"<div style='display:none'>"+pieces[0]+"</div>"+pieces[1],true);this.getTreeSource().setNodeType(node,"OU");}}else this.addChildNodes(node,branchArray[i]);}this.getTreeModal().setData();},moveObject:function(from,to){var callback=qx.lang.Function.bind(this.__moveObjectHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","LDAP","moveObject",from,to);},__moveObjectHandler:function(result,ex,id){},getEntries:function(dn){this.getWireFrame()._setStatusText("Retrieving a list of entries for "+dn+"...");var callback=qx.lang.Function.bind(this.__getEntriesHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","LDAP","getEntries",dn);},__getEntriesHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Error",null);this.getWireFrame()._setStatusText("RPC Error!");return;}if(result){this.getTableRowData().splice(0,this.getTableRowData().length);for(var i=0;i<result.count;i++){var type="";var desc="";var disp="";if(this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("virtualHostFrameworkAccount")>=0){desc=(result[i].description==undefined)?"":result[i].description[0];type="Account";disp=(result[i].displayname==undefined)?result[i].cn[0]:result[i].displayname[0];}if(this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("virtualHostFrameworkPackage")>=0){desc=result[i].packageclasspath[0];type="Package";disp=result[i].cn[0];}if(this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("virtualHostFrameworkRepository")>=0){desc=result[i].repositoryurl[0];type="Repository";disp=result[i].cn[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("virtualHostFrameworkMailingList")>=0)&&!type.length){desc=(result[i].description==undefined)?"":result[i].description[0];type="Group";disp=result[i].cn[0];}if(this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("virtualHostFrameworkPolicy")>=0){desc=(result[i].description==undefined)?"":result[i].description[0];type="Policy";disp=result[i].cn[0];}if(this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("virtualHostFrameworkSQLConnection")>=0){desc=(result[i].description==undefined)?"":result[i].description[0];type="SQLConnection";disp=result[i].databasename[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("posixGroup")>=0)&&!type.length){desc="Security Group";type="posixGroup";disp=result[i].cn[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("groupOfNames")>=0)&&!type.length){desc=(result[i].description==undefined)?"":result[i].description[0];type="groupOfNames";disp=result[i].cn[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("dcObject")>=0)&&!type.length){desc="DNS Zone";type="Zone";disp=(result[i].associateddomain==undefined)?"":result[i].associateddomain[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("dNSDomain")>=0)&&!type.length){desc="DNS Domain";type="Domain";disp=result[i].dc[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("apacheConfig")>=0)){desc="Apache Virtual Host Configuration";type="ApacheConfig";disp=result[i].apacheservername[0];}if((this.getWireFrame().propertiesToArray(result[i].objectclass).indexOf("sudoRole")>=0)&&!type.length){desc=(result[i].description==undefined)?"Sudo Role":result[i].description[0];type="SudoRole";disp=result[i].cn[0];}if(!type.length){var attr=result[i].dn.split(",")[0].split("=")[0];desc=(result[i].description==undefined)?"Miscellaneous LDAP Object":result[i].description[0];type="Misc";disp=eval("result[i]."+attr[0]);}this.getTableRowData().push([disp,desc,type,result[i]]);this.getTableRowData().sort();}this.getTableModel().setData(this.getTableRowData());this.getWireFrame()._setStatusText("Ready");}},__confirmDeleteHandler:function(dn){var callback=qx.lang.Function.bind(this.__doDeleteHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","LDAP","deleteEntry",dn);},__doDeleteHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Error");this.getWireFrame()._setStatusText("RPC Error!");}if(result){var selectedObjects=this.getTable().getSelectionModel().getSelectedRanges();for(var i=0;i<selectedObjects.length;i++){var rowCount=this.getTableModel().getRowCount();for(var j=0;j<rowCount;j++){if(this.getTableModel().getValue(3,j).dn==this.getTable().getTableModel().getValue(3,selectedObjects[i].minIndex).dn)this.getTableModel().removeRows(j,1);}}}},loadContextMenu:function(type,args){this.getWireFrame()._loadPackage("packages.com.makeabyte.vhf.ldapbrowser.ui.contextmenu."+type,args);},terminate:function(){this.base(arguments);}}});
