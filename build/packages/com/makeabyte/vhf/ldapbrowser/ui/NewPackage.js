if(!window.qxsettings)qxsettings={};if(qxsettings["qx.version"]==undefined)qxsettings["qx.version"]="0.0";if(qxsettings["qx.isSource"]==undefined)qxsettings["qx.isSource"]=false;if(!window.qxvariants)qxvariants={};qx.Class.define("packages.com.makeabyte.vhf.ldapbrowser.ui.NewPackage",{extend:vhf.Main,properties:{WireFrame:{init:vhf.Main.getInstance()},NewPackageWin:{},Table:{},ObjPackages:{init:[]},ParentOuDn:{},Callback:{}},construct:function(args){this.setParentOuDn(args[0]);this.setCallback(args[1]);this.__init();},members:{main:function(){this.setNewPackageWin(new qx.ui.window.Window("Install New Package(s)","icon/16/"+this.getWireFrame().getAppIcon()));this.getNewPackageWin().set({showMinimize:true,allowMinimize:false,allowMaximize:true});this.getNewPackageWin().setSpace(225,400,12,400);this.getNewPackageWin().setShowStatusbar(false);this.getNewPackageWin().removeAll();var tableModel=new qx.ui.table.model.Simple();tableModel.setColumns(["Name","Classpath","Version"]);var custom={tableColumnModel:function(obj){return new qx.ui.table.columnmodel.Resize(obj);}};this.setTable(new qx.ui.table.Table(tableModel,custom));with(this.getTable()){set({width:'100%',height:'100%',border:"inset-thin"});setMetaColumnCounts([1,-1]);getSelectionModel().setSelectionMode(qx.ui.table.selection.Model.SINGLE_SELECTION);}var tcm=this.getTable().getTableColumnModel();var resizeBehavior=tcm.getBehavior();resizeBehavior.setWidth(0,100);resizeBehavior.setMinWidth(0,50);resizeBehavior.setMaxWidth(0,300);resizeBehavior.setWidth(1,350);resizeBehavior.setMinWidth(1,50);resizeBehavior.setMaxWidth(1,500);resizeBehavior.setWidth(2,100);resizeBehavior.setMinWidth(2,25);resizeBehavior.setMaxWidth(2,200);this.getNewPackageWin().add(this.getTable());this.getNewPackageWin().open();this.getWireFrame()._addToWorkspace(this.getNewPackageWin());this.getTable().addEventListener("dblclick",function(e){this.installPackage();},this);var rowData=[];for(var i=0;i<this.getObjPackages().length;i++)rowData.push([this.getObjPackages()[i].displayName,this.getObjPackages()[i].classpath,this.getObjPackages()[i].version,this.getObjPackages()[i].location]);this.getTable().getTableModel().setData(rowData);},__init:function(){var callback=qx.lang.Function.bind(this.__getRepositoriesHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","PACKAGE","getRepositories",'[]');},__getRepositoriesHandler:function(result,ex,id){if(ex!=null)this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC ERROR");if(!result.length)this.getWireFrame()._showAlertDialog("error","You must have at least one repository configured before you can install a new package.","New Package",null);if(result){var arrPackageNames=Array(0);this.setObjPackages(Array(0));for(var i=0;i<result.length;i++){var repo=result[i].URL;var req=new qx.io.remote.Request(repo+"/repo.config","GET",qx.util.Mime.JAVASCRIPT);req.setTimeout(this.getWireFrame().getRpcTimeout());req.setCrossDomain(false);req.addEventListener("completed",function(e){try{var objSitePackages=e.getContent();for(var j=0;j<objSitePackages.length;j++){if(arrPackageNames.indexOf(objSitePackages[j].classpath)!=-1)continue;for(var k=0;k<this.getWireFrame().getUserPackages().length;k++){bContinue=false;if(this.getWireFrame().getUserPackages()[k].packageClasspath[0]==objSitePackages[j].classpath){var bContinue=true;break;}}if(bContinue)continue;arrPackageNames.push(objSitePackages[j].classpath);var FQpath=repo+"/"+objSitePackages[j].location;objSitePackages[j].location=FQpath;this.getObjPackages().push(objSitePackages[j]);}if(this.getWireFrame().getPackageRepositories().length==i&&objSitePackages.length==j)this.main();}catch(e){this.getWireFrame()._showAlertDialog("error","Error getting packages: "+e,"Package Display",null);}},this);req.addEventListener("failed",function(e){this.getWireFrame()._showAlertDialog("error","Error loading source file: "+e,"Package Source Loading Error",null);});req.addEventListener("timeout",function(e){this.getWireFrame()._showAlertDialog("error","Could not load the requested source file. Request timed out.","Package Source Loading Error",null);});req.send();}}},installPackage:function(table){var callback=qx.lang.Function.bind(this.__installPackageHandler,this);var selectedObjects=this.getTable().getSelectionModel().getSelectedRanges();for(var i=0;i<selectedObjects.length;i++){var json='['+'{ "name" : "displayName", "displayName" : "'+this.getTable().getTableModel().getValue(0,i)+'"},'+'{ "name" : "cn", "cn" : "'+this.getTable().getTableModel().getValue(0,i)+'"},'+'{ "name" : "packageClasspath", "packageClasspath" : "'+this.getTable().getTableModel().getValue(1,i)+'"},'+'{ "name" : "packageVersion", "packageVersion" : "'+this.getTable().getTableModel().getValue(2,i)+'"},'+'{ "name" : "location", "location" : "'+this.getTable().getTableModel().getValue(3,i)+'"},'+'{ "name" : "parentDn", "parentDn" : "'+this.getParentOuDn()+'"}'+']';this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","PACKAGE","install",json);}},__installPackageHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Error",null);this.getNewPackageWin().setStatus("Ready");return false;}if(result){this.getNewPackageWin().setStatus("Ready");this.getNewPackageWin().close();this.getCallback()(this.getParentOuDn());}},close:function(){this.base(arguments);},terminate:function(){this.base(arguments);}}});
