if(!window.qxsettings)qxsettings={};if(qxsettings["qx.version"]==undefined)qxsettings["qx.version"]="0.0";if(qxsettings["qx.isSource"]==undefined)qxsettings["qx.isSource"]=false;if(!window.qxvariants)qxvariants={};qx.Class.define("packages.core.ui.window.NewPackage",{extend:p2phost.Main,properties:{Parent:{init:p2phost.Main.getInstance()},NewPackageWin:{init:new qx.ui.window.Window("Install New Packages","icon/16/mimetypes/package-x-generic.png")},ObjPackages:{init:Array(0)},PkgName:{init:null},PkgNamespace:{init:null},PkgVersion:{init:null},ParentPkgLv:{init:null},ParentPkgLd:{init:null}},construct:function(arrArgs){this.setParentPkgLv(arrArgs[0]);this.setParentPkgLd(arrArgs[1]);this.__init();},members:{__init:function(){var arrPackageNames=Array(0);this.setObjPackages(Array(0));if(!this.getParent().getPackageRepositories().length)this.getParent()._showAlertDialog("error","You must have at least one repository configured before you can install a new package.","New Package",null);for(var i=0;i<this.getParent().getPackageRepositories().length;i++){var repo=this.getParent().getPackageRepositories()[i].URL;var req=new qx.io.remote.Request(repo+"/repo.config","GET",qx.util.Mime.JAVASCRIPT);req.setTimeout(this.getParent().getRpcTimeout());req.setCrossDomain(false);req.addEventListener("completed",function(e){try{var objSitePackages=e.getContent();for(var j=0;j<objSitePackages.length;j++){if(arrPackageNames.indexOf(objSitePackages[j].namespace)!=-1)continue;for(var k=0;k<this.getParent().getUserPackages().length;k++){bContinue=false;if(this.getParent().getUserPackages()[k].namespace==objSitePackages[j].namespace){var bContinue=true;break;}}if(bContinue)continue;arrPackageNames.push(objSitePackages[j].namespace);var FQpath=repo+"/"+objSitePackages[j].location;objSitePackages[j].location=FQpath;this.getObjPackages().push(objSitePackages[j]);}if(this.getParent().getPackageRepositories().length==i&&objSitePackages.length==j)this.main();}catch(e){this.getParent()._showAlertDialog("error","Error getting packages: "+e,"Package Display",null);}},this);req.addEventListener("failed",function(e){this.getParent()._showAlertDialog("error","Error loading source file: "+e,"Package Source Loading Error",null);});req.addEventListener("timeout",function(e){this.getParent()._showAlertDialog("error","Could not load the requested source file. Request timed out.","Package Source Loading Error",null);});req.send();}},main:function(){this.getNewPackageWin().set({showMinimize:true,allowMinimize:false,allowMaximize:true});this.getNewPackageWin().setSpace(225,400,12,400);this.getNewPackageWin().setShowStatusbar(true);this.getParent()._addToWorkspace(this.getNewPackageWin());var at1=new qx.ui.basic.Atom("Highlight the package(s) you wish to install and click the<br>Install button to proceed with the installation.","icon/22/mimetypes/package-x-generic.png");at1.setLocation(4,4);var pkgLd=[];var pkgLt=["Name","Namespace","Version"];var pkgLc={displayName:{label:"Name",width:100,type:"text",sortable:true,sortProp:"text"},namespace:{label:"Namespace",width:225,type:"text",sortable:true,sortProp:"text"},version:{label:"Version",width:50,type:"text",sortable:true,sortProp:"text"}};var pkgLv=new qx.ui.listview.ListView(pkgLd,pkgLc);pkgLv.setBorder("dark-shadow");pkgLv.setBackgroundColor("white");pkgLv.setWidth(400);pkgLv.setBottom(55);pkgLv.setLocation(3,40);for(var i=0;i<this.getObjPackages().length;i++){pkgLd.push({displayName:{text:this.getObjPackages()[i].displayName},namespace:{text:this.getObjPackages()[i].namespace},version:{text:this.getObjPackages()[i].version}});}pkgLv.updateSort();pkgLv.update();var installBtn=new qx.ui.form.Button("Install","icon/16/apps/internet-download-manager.png");installBtn.set({bottom:15,right:10,enabled:false});installBtn.addEventListener("execute",function(e){this.installPackage(pkgLv,pkgLd,installBtn);},this);pkgLv.getPane().getManager().addEventListener("changeSelection",function(e){installBtn.setEnabled(true);});this.getNewPackageWin().add(at1,pkgLv,installBtn);this.getNewPackageWin().open();},installPackage:function(pkgLv,pkgLd,installBtn){var items=pkgLv.getPane().getManager().getItems();var selectedItems=pkgLv.getPane().getSelectedItems();for(var i=0;i<items.length;i++){for(var j=0;j<selectedItems.length;j++){if(items[i].namespace.text==selectedItems[j].namespace.text){this.getNewPackageWin().setStatus("Installing package "+selectedItems[j].displayName.text+"...");if(!pkgLv.getPane().getSelectedItem().length)installBtn.setEnabled(false);for(var k=0;k<this.getObjPackages().length;k++){if(this.getObjPackages()[k].namespace==items[i].namespace.text){this.setPkgName(this.getObjPackages()[k].displayName);this.setPkgNamespace(this.getObjPackages()[k].namespace);this.setPkgVersion(this.getObjPackages()[k].version);var callback=qx.lang.Function.bind(this.__installPackageHandler,this);this.getParent()._callAsyncRpc(callback,"core.rpc.ui.Packages","installPackage",this.getObjPackages()[k].location,this.getObjPackages()[k].namespace,this.getObjPackages()[k].displayName,this.getObjPackages()[k].version);}}}}}installBtn.setEnabled(false);},__installPackageHandler:function(result,ex,id){if(ex!=null){this.getParent()._showAlertDialog("error",ex.toString(),"RPC Error",null);this.getNewPackageWin().setStatus("Ready");return false;}if(result){this.getParentPkgLd().push({Name:{text:this.getPkgName()},Namespace:{text:this.getPkgNamespace()},Status:{text:"active"},Version:{text:this.getPkgVersion()}});this.getParentPkgLv().updateSort();this.getParentPkgLv().update();this.getParent().getUserPackages().push({namespace:this.getPkgNamespace(),status:"disabled",version:this.getPkgVersion(),displayName:this.getPkgName()});this.getParent()._loadPackage(this.getPkgNamespace());this.getNewPackageWin().setStatus("Ready");this.getNewPackageWin().close();}},close:function(){this.base(arguments);},terminate:function(){this.base(arguments);}}});
