if(!window.qxsettings)qxsettings={};if(qxsettings["qx.version"]==undefined)qxsettings["qx.version"]="0.0";if(qxsettings["qx.isSource"]==undefined)qxsettings["qx.isSource"]=false;if(!window.qxvariants)qxvariants={};qx.Class.define("packages.core.ui.window.Login",{extend:vhf.Main,properties:{WireFrame:{init:vhf.Main.getInstance()}},construct:function(){this.main();},members:{main:function(){var doc=qx.ui.core.ClientDocument.getInstance();var connectWin=new qx.ui.window.Window("Login","icon/16/status/dialog-password.png");connectWin.set({modal:false,showMinimize:false,showMaximize:true,allowMaximize:true,width:350,height:250});var at1=new qx.ui.basic.Atom("Connect to Server","icon/32/status/dialog-password.png");at1.set({top:10,left:10});var btnOK=new qx.ui.form.Button("OK","icon/16/actions/dialog-ok.png");var btnCancel=new qx.ui.form.Button("Cancel","icon/16/actions/dialog-cancel.png");btnOK.set({bottom:10,right:10});btnCancel.set({bottom:10,right:60});var txtServerLabel=new qx.ui.basic.Atom("Server");txtServerLabel.setHorizontalChildrenAlign("right");txtServerLabel.set({top:75,left:30,width:'10%'});var txtServer=new qx.ui.form.TextField();txtServer.set({top:75,right:30,width:'70%',value:window.location.host});var txtTip="The IP or domain to establish a connection<br><b>Example: </b>localhost";var tipIcon=new qx.ui.basic.Atom("","icon/16/apps/accessories-tip.png");tipIcon.set({top:75,right:10});var tooltipBtn=new qx.ui.basic.Atom(txtTip);var tt1=new qx.ui.popup.ToolTip(txtTip);tipIcon.setToolTip(tt1);var txtUsernameLabel=new qx.ui.basic.Atom("Username");txtUsernameLabel.setHorizontalChildrenAlign("right");txtUsernameLabel.set({top:100,left:30,width:'10%'});var txtUsername=new qx.ui.form.TextField();txtUsername.set({top:100,right:30,width:'70%',value:'vhfadmin'});var txtUsernameTip="The username to authenticate<br><b>Example: </b>siteadmin";var usernameTipIcon=new qx.ui.basic.Atom("","icon/16/apps/accessories-tip.png");usernameTipIcon.set({top:100,right:10});var usernameTipBtn=new qx.ui.basic.Atom(txtUsernameTip);var tt2=new qx.ui.popup.ToolTip(txtUsernameTip);usernameTipIcon.setToolTip(tt2);var txtPasswordLabel=new qx.ui.basic.Atom("Password");txtPasswordLabel.setHorizontalChildrenAlign("right");txtPasswordLabel.set({top:125,left:30,width:'10%'});var txtPassword=new qx.ui.form.PasswordField();txtPassword.set({top:125,right:30,width:'70%',value:'secret'});var txtPasswordTip="The password to authenticate<br><b>Example: </b>secret";var passwordTipIcon=new qx.ui.basic.Atom("","icon/16/apps/accessories-tip.png");passwordTipIcon.set({top:125,right:10});var passwordTipBtn=new qx.ui.basic.Atom(txtPasswordTip);var tt3=new qx.ui.popup.ToolTip(txtPasswordTip);passwordTipIcon.setToolTip(tt3);var chk1=new qx.ui.form.CheckBox("Use SSL");chk1.setLocation('20.5%',150);chk1.setChecked(true);var txtSslTip="Check to use Secure Sockets Layer";var sslTipIcon=new qx.ui.basic.Atom("","icon/16/apps/accessories-tip.png");sslTipIcon.set({top:150,right:10});var sslTipBtn=new qx.ui.basic.Atom(txtSslTip);var tt4=new qx.ui.popup.ToolTip(txtSslTip);sslTipIcon.setToolTip(tt4);btnOK.addEventListener("execute",function(e){this.getWireFrame().setRpcServer(txtServer.getValue()+"/packages/jsonrpc.php");this.getWireFrame().setRpcUser(txtUsername.getValue());this.getWireFrame().setRpcPass(txtPassword.getValue());this.getWireFrame().setRpcSsl(chk1.isChecked());if(!txtUsername.getValue().length||!txtPassword.getValue.length){this.getWireFrame()._showAlertDialog("error","You must enter a username and password.","Authentication Error",null);return (false);}(txtServer.indexOf(window.location.host)==-1)?this.getWireFrame().setRpcCrossDomain(true):this.getWireFrame().setRpcCrossDomain(false);this.getWireFrame().setRpcProtocol((this.getRpcSsl()==true)?"https://":"http://");if(this.getRpcServer().indexOf(location.host)!=-1&&this.getRpcServer().indexOf("."+location.host)==-1)this.getWireFrame().setRpcCrossDomain(true);if(location.protocol.indexOf("http")!=-1&&this.getRpcSsl()==true)this.getWireFrame().setRpcCrossDomain(true);if(location.protocol.indexOf("https")!=-1&&this.getRpcSsl()==false)this.getWireFrame().setRpcCrossDomain(true);this.getWireFrame()._setStatusText("Attempting connection...");var json='['+'{ "name" : "uid", "uid" : "'+txtUsername.getValue()+'"},'+'{ "name" : "cn", "cn" :"'+txtUsername.getValue()+'"},'+'{ "name" : "userPassword", "userPassword" :"'+txtPassword.getValue()+'"}'+']';var callback=qx.lang.Function.bind(this.__authenticationHandler,this);this.getWireFrame()._callAsyncRpc(callback,"core.rpc.API","invoke","ACCOUNT","authenticate",json);connectWin.close();},this);btnCancel.addEventListener("execute",function(e){connectWin.close();});var lblForgotPassword=new qx.ui.basic.Atom("<a href='#'>Forgot Password</a>");lblForgotPassword.set({bottom:10,left:10});lblForgotPassword.addEventListener("click",function(e){this.getWireFrame()._showAlertDialog("info","This feature has not been implemented yet...","Forgot Password");},this);connectWin.add(at1,txtServerLabel,txtServer,btnOK,btnCancel,tipIcon);connectWin.add(txtUsernameLabel,txtUsername,usernameTipIcon);connectWin.add(txtPasswordLabel,txtPassword,passwordTipIcon);connectWin.add(chk1,sslTipIcon);connectWin.add(lblForgotPassword);connectWin.addEventListener("appear",connectWin.centerToBrowser,connectWin);connectWin.open();doc.add(connectWin);},__authenticationHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._getLoadingWin().close();this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Error",null);this.getWireFrame()._setStatusText("Ready");return false;}if(!result){this.getWireFrame()._getLoadingWin().close();this.getWireFrame()._setStatusText("Ready");this.getWireFrame()._showAlertDialog("error","Invalid username or password.","Authentication Failure",null);}if(result){this.getWireFrame()._setStatusText("Authentication successful...");this.getWireFrame().setUserAttribs(result);this.getWireFrame().getLoginBtn().setEnabled(false);this.getWireFrame().getLogoutBtn().setEnabled(true);this.getWireFrame().getPreferencesBtn().setEnabled(true);this.__getExteralSites();this.__getPackages();if(result.accountrole[0]=="administrator"){this.getWireFrame().getSoftwareUpdatesBtn().setEnabled(true);this.getWireFrame().getSettingsBtn().setEnabled(true);this.__getPackageRepositories();}else this.getWireFrame()._loadPackage("packages.core.ui.Desktop");}},__getExteralSites:function(){this.getWireFrame()._setStatusText("Loading external site buttons...");var rpc=new qx.io.remote.Rpc;rpc.setUrl(this.getWireFrame().getRpcProtocol()+this.getWireFrame().getRpcServer());rpc.setServiceName("core.rpc.api.Preferences");rpc.setTimeout(this.getWireFrame().getRpcTimeout());rpc.setCrossDomain(this.getWireFrame().getRpcCrossDomain());var callback=new qx.lang.Function.bind(this.__getExternalSitesHandler,this);rpc.callAsync(callback,"getExternalSites",this.getWireFrame().getUserAttribs().dn);},__getExternalSitesHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._setStatusText("Ready");this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Failure");return;}if(result){this.getWireFrame().setExternalSites(result);for(var i=0;i<result.length;i++)this.getWireFrame()._setToolbarButton(result[i].name,result[i].url);this.getWireFrame()._setStatusText("Ready");}},__getPackages:function(){this.getWireFrame()._setStatusText("Loading packages...");var rpc=new qx.io.remote.Rpc;rpc.setUrl(this.getWireFrame().getRpcProtocol()+this.getWireFrame().getRpcServer());rpc.setServiceName("core.rpc.API");rpc.setTimeout(this.getWireFrame().getRpcTimeout());rpc.setCrossDomain(this.getWireFrame().getRpcCrossDomain());var json='[{ "name" : "rpcRequestorDn", "rpcRequestorDn" : "'+this.getWireFrame().getUserAttribs().dn+'"}]';var callback=qx.lang.Function.bind(this.__getPackagesHandler,this);rpc.callAsync(callback,"invoke","PACKAGE","getPackages",json);},__getPackagesHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex.toString(),"RPC Connection Failure",null);this.getWireFrame()._setStatusText("Ready");return;}if(!result){this.getWireFrame()._showAlertDialog("error","You do not have any packages provisioned for your account. Please contact support for assistance.","Packages Load Error",null);this.getWireFrame()._getLoadingWin().close();return;}this.getWireFrame().setUserPackages(result[0]);for(i=0;i<result.length;i++){if(result[i].packagestatus[0]!="active")continue;this.getWireFrame()._loadPackage(result[i].packageclasspath[0],null);}this.getWireFrame()._getLoadingWin().close();this.getWireFrame().getOpenBtn().setEnabled(true);this.getWireFrame()._setStatusText("Ready");},__getPackageRepositories:function(){this.getWireFrame()._setStatusText("Loading package repositories...");var rpc=new qx.io.remote.Rpc;rpc.setUrl(this.getWireFrame().getRpcProtocol()+this.getWireFrame().getRpcServer());rpc.setServiceName("core.rpc.API");rpc.setTimeout(this.getWireFrame().getRpcTimeout());rpc.setCrossDomain(this.getWireFrame().getRpcCrossDomain());var callback=new qx.lang.Function.bind(this.__getPackagesRepositoriesHandler,this);rpc.callAsync(callback,"invoke","PACKAGE","getRepositories","[]");},__getPackagesRepositoriesHandler:function(result,ex,id){if(ex!=null){this.getWireFrame()._showAlertDialog("error",ex,"RPC Connection Failure",null);this.getWireFrame()._setStatusText("Ready");return;}if(!result){this.getWireFrame()._showAlertDialog("error","An error occurred while attempting to load repositories list. No repositories found.","Packages Error",null);this.getWireFrame()._getLoadingWin().close();return;}if(result){this.getWireFrame().setPackageRepositories(result);this.getWireFrame()._setStatusText("Ready");}},close:function(){this.base(arguments);},terminate:function(){this.base(arguments);}}});
